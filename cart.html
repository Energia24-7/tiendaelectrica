<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito - Tienda El√©ctrica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .container { margin-top: 30px; }
    .cart-table th, .cart-table td { vertical-align: middle; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">üõí Tienda El√©ctrica</a>
  </div>
</nav>

<div class="container">
  <h2 class="my-4">Carrito de Compras</h2>
  <div id="cart-container"></div>

  <div class="mt-4">
    <h4>Resumen</h4>
    <p><b>Subtotal:</b> $<span id="subtotal">0.00</span></p>
    <p><b>IVA (15%):</b> $<span id="iva">0.00</span></p>
    <p><b>Total:</b> $<span id="total">0.00</span></p>
  </div>

  <div class="mt-4">
    <h4>Pedir Cotizaci√≥n</h4>
    <form id="quote-form">
      <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input type="text" id="name" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Tel√©fono</label>
        <input type="text" id="phone" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="email" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-success">üì© Enviar Cotizaci√≥n</button>
    </form>
  </div>
</div>

<script>
  // Inicializa EmailJS
  (function() {
    emailjs.init("12KodIR87XG-5sLqB"); // <-- Pega aqu√≠ tu Public Key de EmailJS
  })();

  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  function renderCart() {
    const container = document.getElementById("cart-container");
    container.innerHTML = "";

    if (cart.length === 0) {
      container.innerHTML = "<div class='alert alert-info'>Tu carrito est√° vac√≠o.</div>";
      updateSummary();
      return;
    }

    const table = document.createElement("table");
    table.className = "table cart-table";
    table.innerHTML = `
      <thead class="table-dark">
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody>
        ${cart.map((item, i) => `
          <tr>
            <td>${item.marca} - ${item.modelo}</td>
            <td>$${item.precio}</td>
            <td>
              <input type="number" class="form-control form-control-sm" value="${item.cantidad || 1}" min="1"
                onchange="updateQuantity(${i}, this.value)">
            </td>
            <td>$${(item.precio * (item.cantidad || 1)).toFixed(2)}</td>
            <td><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">üóë Eliminar</button></td>
          </tr>
        `).join("")}
      </tbody>
    `;
    container.appendChild(table);
    updateSummary();
  }

  function updateQuantity(index, qty) {
    cart[index].cantidad = parseInt(qty);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function updateSummary() {
    let subtotal = cart.reduce((sum, item) => sum + item.precio * (item.cantidad || 1), 0);
    let iva = subtotal * 0.15;
    let total = subtotal + iva;

    document.getElementById("subtotal").textContent = subtotal.toFixed(2);
    document.getElementById("iva").textContent = iva.toFixed(2);
    document.getElementById("total").textContent = total.toFixed(2);
  }

  document.getElementById("quote-form").addEventListener("submit", function(e) {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;

    const orderDetails = cart.map(item => 
      `${item.marca} - ${item.modelo} x${item.cantidad || 1} = $${(item.precio * (item.cantidad || 1)).toFixed(2)}`
    ).join("\n");

    const params = {
      user_name: name,
      user_phone: phone,
      user_email: email,
      message: `
Cotizaci√≥n solicitada:

Items:
${orderDetails}

Subtotal: $${document.getElementById("subtotal").textContent}
IVA: $${document.getElementById("iva").textContent}
Total: $${document.getElementById("total").textContent}
`
    };

    emailjs.send("service_da5iz2u", "template_vail7ma", params)
      .then(function() {
        alert("‚úÖ Cotizaci√≥n enviada con √©xito.");
        localStorage.removeItem("cart");
        cart = [];
        renderCart();
      }, function(error) {
        alert("‚ùå Error al enviar cotizaci√≥n: " + JSON.stringify(error));
      });
  });

  renderCart();
</script>

</body>
</html>
